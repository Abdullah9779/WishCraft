{% extends "base.html" %}

{% block seo %}
<title>WishCraft ‚Äî Create a Personalized Love Letter Template</title>
<meta name="description" content="Step 2: Add fonts and finalize your WishCraft template. Choose fonts, images, and preview your card before saving.">
<link rel="canonical" href="{{ request.url }}">
<link rel="icon" href="https://dotcoder.site/static/wishcraft/icon/wishcraft-favicon.png">
<meta property="og:title" content="Customize your WishCraft template ‚Äî Step 2">
<meta property="og:description" content="Add fonts and finalize your personalized wish card template on WishCraft.">
<meta property="og:image" content="https://dotcoder.site/static/wishcraft/icon/wishcraft-logo.png">
<meta name="twitter:card" content="summary_large_image">
{% endblock %}

{% block body %}
<div class="min-h-screen bg-gradient-to-br from-purple-50 via-blue-50 to-pink-50 py-8">
    <section class="py-8 px-4 sm:px-6 lg:px-8">
        <div class="flex justify-center">
            <script type="text/javascript">
                atOptions = {
                    'key': '5f7f08c41ce8081a1187f4f6946985a3',
                    'format': 'iframe',
                    'height': 90,
                    'width': 728,
                    'params': {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/5f7f08c41ce8081a1187f4f6946985a3/invoke.js"></script>
        </div>
    </section>

    <div class="max-w-2xl mx-auto bg-white shadow-2xl rounded-2xl p-4 sm:p-6 lg:p-8 border border-gray-100 mx-4 sm:mx-auto">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-gradient-to-r from-purple-500 to-pink-500 rounded-full mb-4">
                <span class="text-2xl">üíï</span>
            </div>
            <h2 class="text-3xl font-bold bg-gradient-to-r from-purple-600 to-pink-600 bg-clip-text text-transparent mb-2">
                Create a Personalized Love Letter
            </h2>
            <p class="text-gray-600">Design a tender, beautifully styled love letter with your own heartfelt message and optional music.</p>
        </div>

        <!-- Loading Spinner -->
        <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 flex items-center space-x-3">
                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-purple-600"></div>
                <span class="text-gray-700 font-medium">Creating your love letter ‚Äî please wait...</span>
            </div>
        </div>

        <!-- Success Message -->
        <div id="success-message" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-lg">
            <div class="flex items-center">
                <span class="text-green-600 text-xl mr-2">‚úÖ</span>
                <span class="text-green-800 font-medium">Love letter created successfully!</span>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error-message-global" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
            <div class="flex items-center">
                <span class="text-red-600 text-xl mr-2">‚ùå</span>
                <span class="text-red-800 font-medium" id="error-text">Something went wrong. Please try again.</span>
            </div>
        </div>

        <form id="template-form">

            <div class="mb-6">
                <label for="name" class="block text-gray-800 font-semibold mb-2 flex items-center">
                    <span class="mr-2">üíù</span>
                    Letter For
                </label>
                <input type="text" id="name" name="name" required placeholder="For My Love"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 outline-none">
            </div>

            <!-- Personal Message -->
            <div class="mb-6">
                <label for="wish" class="block text-gray-800 font-semibold mb-2 flex items-center">
                    <span class="mr-2">üíå</span>
                    Your Heartfelt Personal Message
                </label>
                <textarea id="wish" name="wish" rows="6" required placeholder="Write your heartfelt message here..."
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 outline-none resize-none">My Dearest,

From the moment we met, you've filled my life with so much joy and happiness. Your smile is my favorite sight, and your laughter is my favorite sound.

Every day with you is a blessing I cherish. You're not just my love, you're my best friend, my confidant, and my greatest adventure.

I love the way you make me feel - like I can accomplish anything with you by my side. You've shown me what true love really means, and for that, I am eternally grateful.

No matter where life takes us, I promise to always stand by your side, to support you, and to love you with all my heart.

Forever and always,</textarea>
                <p class="text-sm text-gray-500 mt-1">Write a sincere message ‚Äî include details that make it uniquely personal.</p>
            </div>

            <!-- Signature -->
            <div class="mb-6">
                <label for="signature" class="block text-gray-800 font-semibold mb-2 flex items-center">
                    <span class="mr-2">‚úçÔ∏è</span>
                    Your Signature
                </label>
                <input type="text" id="signature" name="signature" required placeholder="Your name or signature (Yours truly)"
                    class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 outline-none">
            </div>

            <!-- Font Style -->
            <div class="mb-6">
                <label class="block text-gray-800 font-semibold mb-2 flex items-center">
                    <span class="mr-2">üé®</span>
                    Choose Font Style
                </label>
                <div class="font-dropdown relative">
                    <div class="input-box flex items-center">
                        <input type="text" id="fontDisplay" placeholder="üé® Search and select a font..."
                            class="flex-1 px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border-2 border-gray-200 rounded-l-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 outline-none">
                        <input type="hidden" id="font" name="font">
                        <button type="button" id="fontToggleBtn" class="px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-200 border-l-0 bg-gray-50 rounded-r-xl hover:bg-gray-100 transition-all duration-200 font-bold text-sm sm:text-base">‚ñº</button>
                    </div>
                    <div class="font-dropdown-content bg-white w-full max-h-40 sm:max-h-48 overflow-y-auto border border-gray-200 rounded-xl mt-1 hidden z-10 absolute shadow-lg">
                        <!-- Fonts will be populated by JavaScript -->
                    </div>
                </div>
            </div>

            <!-- Background Music -->
            <div class="mb-6">
                <label class="block text-gray-800 font-semibold mb-2 flex items-center">
                    <span class="mr-2">üéµ</span>
                    Choose Background Music
                </label>
                <div class="song-dropdown relative">
                    <div class="input-box flex items-center">
                        <input type="text" id="songDisplay" placeholder="üé∂ Search and select a song..."
                            class="flex-1 px-3 sm:px-4 py-2 sm:py-3 text-sm sm:text-base border-2 border-gray-200 rounded-l-xl focus:ring-2 focus:ring-purple-500 focus:border-purple-500 transition-all duration-200 outline-none">
                        <input type="hidden" id="song" name="song">
                        <button type="button" id="songToggleBtn" class="px-3 sm:px-4 py-2 sm:py-3 border-2 border-gray-200 border-l-0 bg-gray-50 rounded-r-xl hover:bg-gray-100 transition-all duration-200 font-bold text-sm sm:text-base">‚ñº</button>
                    </div>
                    <div class="dropdown-content bg-white w-full max-h-40 sm:max-h-48 overflow-y-auto border border-gray-200 rounded-xl mt-1 hidden z-10 absolute shadow-lg">
                        <div class="p-2 sm:p-3 text-sm sm:text-base cursor-pointer hover:bg-gray-50 border-b border-gray-100" data-url="" data-title="üé∂ No background music">
                            üé∂ No background music
                        </div>
                        {% for song_key, song_data in songs %}
                        <div class="p-2 sm:p-3 text-sm sm:text-base cursor-pointer hover:bg-gray-50 border-b border-gray-100 last:border-b-0" data-url="{{ song_data.song_url }}" data-title="{{ song_data.song_title }}">
                            {{ song_data.song_title }}
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Preview Song -->
            <div class="mb-8">
                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-xl border">
                    <span class="text-gray-700 font-medium">üéß Song Preview</span>
                    <button type="button" id="previewBtn" onclick="togglePlay()" disabled
                        class="px-6 py-2 bg-gradient-to-r from-purple-500 to-pink-500 text-white rounded-full font-medium disabled:opacity-50 disabled:cursor-not-allowed hover:shadow-lg transition-all duration-200">
                        ‚ñ∂Ô∏è Play Preview
                    </button>
                </div>
                <audio id="audioPlayer" class="w-full mt-3 hidden"></audio>
            </div>

            <!-- Submit Button -->
            <button type="submit" id="submit-btn"
                class="w-full bg-gradient-to-r from-purple-600 via-pink-600 to-purple-700 hover:from-purple-700 hover:via-pink-700 hover:to-purple-800 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl transform hover:scale-105 transition-all duration-200 flex items-center justify-center space-x-2">
                <span>üíï</span>
                <span>Create Letter</span>
            </button>
        </form>
    </div>

    <section class="py-8 px-4 sm:px-6 lg:px-8">
        <div class="flex justify-center">
            <script type="text/javascript">
                atOptions = {
                    'key': '5f7f08c41ce8081a1187f4f6946985a3',
                    'format': 'iframe',
                    'height': 90,
                    'width': 728,
                    'params': {}
                };
            </script>
            <script type="text/javascript" src="//www.highperformanceformat.com/5f7f08c41ce8081a1187f4f6946985a3/invoke.js"></script>
        </div>
    </section>
</div>

<script>
    // Song dropdown functionality
    const songDisplay = document.getElementById("songDisplay");
    const songInput = document.getElementById("song");
    const dropdownContent = document.querySelector(".dropdown-content");
    const songToggleBtn = document.getElementById("songToggleBtn");
    const audioPlayer = document.getElementById("audioPlayer");
    const previewBtn = document.getElementById("previewBtn");

    // Filter dropdown items based on search
    function filterSongs(searchTerm) {
        const items = dropdownContent.querySelectorAll("div");
        let hasVisible = false;
        items.forEach(item => {
            const title = item.textContent.toLowerCase();
            if (title.includes(searchTerm.toLowerCase())) {
                item.style.display = "block";
                hasVisible = true;
            } else {
                item.style.display = "none";
            }
        });
        dropdownContent.style.display = hasVisible ? "block" : "none";
    }

    // Search input event
    songDisplay.addEventListener("input", () => {
        if (songDisplay.value.trim() === "") {
            dropdownContent.style.display = "none";
            songInput.value = "";
        } else {
            filterSongs(songDisplay.value);
        }
        updateSong();
    });

    // Toggle button click
    songToggleBtn.addEventListener("click", () => {
        if (dropdownContent.style.display === "block") {
            dropdownContent.style.display = "none";
        } else {
            filterSongs("");
        }
    });

    // Click on dropdown item
    dropdownContent.addEventListener("click", (e) => {
        if (e.target.tagName === "DIV") {
            songDisplay.value = e.target.dataset.title;
            songInput.value = e.target.dataset.url;
            dropdownContent.style.display = "none";
            updateSong();
        }
    });

    // Close dropdown when clicking outside
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".song-dropdown")) {
            dropdownContent.style.display = "none";
        }
    });

    // Song preview functionality
    function updateSong() {
        if (songInput.value && songInput.value.startsWith('http')) {
            audioPlayer.src = songInput.value;
            previewBtn.disabled = false;
            audioPlayer.classList.remove("hidden");
        } else {
            previewBtn.disabled = true;
            audioPlayer.classList.add("hidden");
        }
    }

    function togglePlay() {
        const audioPlayer = document.getElementById("audioPlayer");
        const previewBtn = document.getElementById("previewBtn");

        if (audioPlayer.paused) {
            audioPlayer.play();
            previewBtn.innerHTML = "‚è∏Ô∏è Pause Preview";
        } else {
            audioPlayer.pause();
            previewBtn.innerHTML = "‚ñ∂Ô∏è Play Preview";
        }
    }

    // Font dropdown functionality
    const allFonts = ['Arial','Helvetica','Times New Roman','Courier New','Verdana','Georgia','Palatino','Garamond','Bookman','Comic Sans MS','Trebuchet MS','Arial Black','Impact','Lucida Sans Unicode','Tahoma','Lucida Console','Dancing Script','Great Vibes','Pacifico','Lobster','Roboto','Open Sans','Lato','Montserrat','Source Sans Pro','Raleway','PT Sans','Ubuntu','Nunito','Playfair Display','Merriweather','Poppins','Oswald','Lora','Quicksand','Rubik','Work Sans','Fira Sans','Noto Sans','Crimson Text','EB Garamond','Libre Baskerville','PT Serif','Source Serif Pro','Bitter','Arvo','Rokkitt','Vollkorn','Cardo','Gentium Basic','Neuton','Alegreya','Cormorant Garamond','Spectral','IBM Plex Serif','Zilla Slab','Slabo 27px','Abril Fatface','Alfa Slab One','Bree Serif','Crete Round','Josefin Slab','Patua One','Volkhov','Amatic SC','Caveat','Kaushan Script','Satisfy','Alex Brush','Allura','Courgette','Sacramento','Tangerine','Yellowtail','Parisienne','Grand Hotel','Great Vibes','Pinyon Script','Rochester','Clicker Script','Devonshire','Euphoria Script','Herr Von Muellerhoff','Italianno','Marck Script','Mr De Haviland','Niconne','Petit Formal Script','Rouge Script','Shadows Into Light','Arizonia','Berkshire Swash','Bilbo Swash Caps','Calligraffitti','Cedarville Cursive','Cookie','Damion','Dawning of a New Day','Delius','Fasthand','Felipa','Finger Paint','Fondamento','Give You Glory','Gloria Hallelujah','Gochi Hand','Handlee','Homemade Apple','Indie Flower','Jim Nightshade','Just Another Hand','Just Me Again Down Here','La Belle Aurore','League Script','Leckerli One','Love Ya Like A Sister','Loved by the King','Lovers Quarrel','Meie Script','Merienda','Miss Fajardose','Monsieur La Doulaise','Montez','Mr Bedfort','Mr Dafoe','Mrs Saint Delafield','Mrs Sheppards','Norican','Nothing You Could Do','Over the Rainbow','Patrick Hand','Permanent Marker','Qwigley','Reenie Beanie','Rock Salt','Ruthie','Schoolbell','Seaweed Script','Short Stack','Sue Ellen Francisco','Sunshiney','Swanky and Moo Moo','The Girl Next Door','Waiting for the Sunrise','Walter Turncoat','Yesteryear','Zeyada'];
    
    const fontDisplay = document.getElementById("fontDisplay");
    const fontInput = document.getElementById("font");
    const fontDropdownContent = document.querySelector(".font-dropdown-content");
    const fontToggleBtn = document.getElementById("fontToggleBtn");

    // Populate font dropdown
    function populateFontDropdown() {
        fontDropdownContent.innerHTML = "";
        allFonts.forEach(font => {
            const item = document.createElement("div");
            item.textContent = font;
            item.className = "p-2 sm:p-3 text-sm sm:text-base cursor-pointer hover:bg-gray-50 border-b border-gray-100 last:border-b-0";
            item.style.fontFamily = font;
            item.dataset.font = font;
            fontDropdownContent.appendChild(item);
        });
    }

    // Filter font dropdown items
    function filterFonts(searchTerm) {
        const items = fontDropdownContent.querySelectorAll("div");
        let hasVisible = false;
        items.forEach(item => {
            const fontName = item.textContent.toLowerCase();
            if (fontName.includes(searchTerm.toLowerCase())) {
                item.style.display = "block";
                hasVisible = true;
            } else {
                item.style.display = "none";
            }
        });
        fontDropdownContent.style.display = hasVisible ? "block" : "none";
    }

    // Font search input event
    fontDisplay.addEventListener("input", () => {
        if (fontDisplay.value.trim() === "") {
            fontDropdownContent.style.display = "none";
            fontInput.value = "";
        } else {
            filterFonts(fontDisplay.value);
        }
        updateFontPreview();
    });

    // Font toggle button click
    fontToggleBtn.addEventListener("click", () => {
        if (fontDropdownContent.style.display === "block") {
            fontDropdownContent.style.display = "none";
        } else {
            filterFonts("");
        }
    });

    // Click on font dropdown item
    fontDropdownContent.addEventListener("click", (e) => {
        if (e.target.tagName === "DIV") {
            fontDisplay.value = e.target.dataset.font;
            fontInput.value = e.target.dataset.font;
            fontDropdownContent.style.display = "none";
            updateFontPreview();
        }
    });

    // Close font dropdown when clicking outside
    document.addEventListener("click", (e) => {
        if (!e.target.closest(".font-dropdown")) {
            fontDropdownContent.style.display = "none";
        }
    });

    // Update font preview
    function updateFontPreview() {
        const textarea = document.getElementById('wish');
        if (fontInput.value) {
            textarea.style.fontFamily = fontInput.value;
        }
    }
    
    // populate font dropdown immediately (script is loaded after definitions)
    if (typeof populateFontDropdown === 'function') populateFontDropdown();

    // Form submission with API call
    document.getElementById("template-form").addEventListener("submit", async function (event) {
        event.preventDefault();

        const form = event.target;
        const submitBtn = document.getElementById("submit-btn");
        const loading = document.getElementById("loading");
        const successMessage = document.getElementById("success-message");
        const errorMessageGlobal = document.getElementById("error-message-global");
        const errorText = document.getElementById("error-text");

        // No images for this template
        const images = [];

        // Prepare JSON data
        const jsonData = {
            name: "Love Letter",
            date: new Date().toISOString().split('T')[0],
            wish: document.getElementById("wish").value,
            signature: document.getElementById("signature").value,
            name: document.getElementById("name").value,
            font: document.getElementById("font").value,
            song: document.getElementById("song").value,
            font: document.getElementById("font").value,
            images: images,
            template_id: {{ template_id }}
        };

        // Show loading state
        loading.classList.remove("hidden");
        submitBtn.disabled = true;
        successMessage.classList.add("hidden");
        errorMessageGlobal.classList.add("hidden");

        try {
            const csrfToken = window.getCSRFToken ? window.getCSRFToken() : '';
            const response = await fetch("{% url 'create_template_api' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": csrfToken
                },
                body: JSON.stringify(jsonData)
            });

            const result = await response.json();

            if (response.ok) {
                // Success
                successMessage.classList.remove("hidden");
                form.reset();
                document.getElementById("previewBtn").disabled = true;
                document.getElementById("audioPlayer").classList.add("hidden");

                // Scroll to success message
                successMessage.scrollIntoView({ behavior: "smooth" });

                // Redirect to share page after success
                setTimeout(() => {
                    if (result.templateUrl) {
                        window.location.href = result.templateUrl;
                    }
                }, 100);
            } else {
                // Error from server
                errorText.textContent = result.message || "Failed to create love letter. Please try again.";
                errorMessageGlobal.classList.remove("hidden");
                errorMessageGlobal.scrollIntoView({ behavior: "smooth" });
            }
        } catch (error) {
            // Network or other error
            console.error("Error creating love letter:", error);
            errorText.textContent = "Network error. Please check your connection and try again.";
            errorMessageGlobal.classList.remove("hidden");
            errorMessageGlobal.scrollIntoView({ behavior: "smooth" });
        } finally {
            // Hide loading state
            loading.classList.add("hidden");
            submitBtn.disabled = false;
        }
    });

    // Auto-pause audio when user navigates away
    window.addEventListener("beforeunload", function () {
        const audioPlayer = document.getElementById("audioPlayer");
        if (!audioPlayer.paused) {
            audioPlayer.pause();
        }
    });
</script>

{% endblock %}